pipeline {
    agent any

    environment {
        REGISTRY = 'balaakashreddyy'      // DockerHub username
        APP_NAME = 'job-portal-canary'
        GIT_REPO = 'https://github.com/AkashReddy123/job-portal-canary.git'
        EC2_IP = '50.17.54.191'            // üëà Replace with EC2 Public IP
    }

    stages {
        stage('Checkout Code') {
            steps {
                echo 'üì• Checking out project source from GitHub...'
                git branch: 'main', url: "${GIT_REPO}"
            }
        }

        stage('Build Frontend V1 & V2') {
            steps {
                echo 'üèóÔ∏è Building Frontend V1...'
                dir('frontend-v1') {
                    bat 'npm install'
                    bat 'npm run build'
                }

                echo 'üèóÔ∏è Building Frontend V2...'
                dir('frontend-v2') {
                    bat 'npm install'
                    bat 'npm run build'
                }
            }
        }

        stage('Build Backend') {
            steps {
                echo '‚öôÔ∏è Building Backend...'
                dir('backend') {
                    bat 'npm install'
                }
            }
        }

        stage('Build Docker Images') {
            steps {
                echo 'üê≥ Building Docker Images...'
                bat 'docker-compose build'
            }
        }

        stage('Push to DockerHub') {
            steps {
                echo 'üì¶ Pushing Docker Images to DockerHub...'
                withCredentials([usernamePassword(credentialsId: 'dockerhub-login', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
                    bat '''
                    docker login -u %DOCKER_USER% -p %DOCKER_PASS%

                    docker tag job-portal-canary-pipeline-web_v1:latest %DOCKER_USER%/job-portal-canary-web_v1:latest
                    docker tag job-portal-canary-pipeline-web_v2:latest %DOCKER_USER%/job-portal-canary-web_v2:latest
                    docker tag job-portal-canary-pipeline-backend:latest %DOCKER_USER%/job-portal-canary-backend:latest

                    docker push %DOCKER_USER%/job-portal-canary-web_v1:latest
                    docker push %DOCKER_USER%/job-portal-canary-web_v2:latest
                    docker push %DOCKER_USER%/job-portal-canary-backend:latest
                    '''
                }
            }
        }

        stage('Deploy Canary (V2 alongside V1)') {
            steps {
                echo 'üöÄ Deploying Canary version (V2) to EC2...'
                sshagent(['ec2-key']) {
                    bat '''
                    ssh -o StrictHostKeyChecking=no ubuntu@%EC2_IP% "
                        cd /home/ubuntu/job-portal-canary &&
                        git pull &&
                        echo 'üü° Starting Canary containers (V2)...' &&
                        docker-compose -f docker-compose.yml up -d web_v2
                    "
                    '''
                }
            }
        }

        stage('Traffic Split 90/10') {
            steps {
                echo '‚öñÔ∏è Adjusting NGINX traffic to 90% V1 and 10% V2...'
                sshagent(['ec2-key']) {
                    bat '''
                    ssh -o StrictHostKeyChecking=no ubuntu@%EC2_IP% "
                        sudo sed -i 's/weight=9;/weight=9;/' nginx/nginx.conf
                        sudo sed -i 's/weight=1;/weight=1;/' nginx/nginx.conf
                        sudo docker restart nginx_lb
                    "
                    '''
                }
            }
        }

        stage('Promote Canary (Switch Fully to V2)') {
            input {
                message "üü¢ Promote Canary (V2) to full production?"
                ok "Promote"
            }
            steps {
                echo '‚úÖ Promoting Canary (V2) to full traffic...'
                sshagent(['ec2-key']) {
                    bat '''
                    ssh -o StrictHostKeyChecking=no ubuntu@%EC2_IP% "
                        sudo sed -i 's/weight=9;/weight=0;/' nginx/nginx.conf &&
                        sudo sed -i 's/weight=1;/weight=10;/' nginx/nginx.conf &&
                        sudo docker restart nginx_lb
                    "
                    '''
                }
            }
        }

        stage('Remove Old Version (V1)') {
            steps {
                echo 'üßπ Removing old V1 containers after successful canary rollout...'
                sshagent(['ec2-key']) {
                    bat '''
                    ssh -o StrictHostKeyChecking=no ubuntu@%EC2_IP% "
                        docker-compose stop web_v1 &&
                        docker-compose rm -f web_v1
                    "
                    '''
                }
            }
        }
    }

    post {
        success {
            echo '‚úÖ Zero-downtime Canary Deployment completed successfully!'
        }
        failure {
            echo '‚ùå Something failed during Canary rollout! Please check logs.'
        }
    }
}
